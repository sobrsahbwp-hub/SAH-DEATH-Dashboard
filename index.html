<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DEATH DATA DASHBOARD - SAH</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:#f4f8fc;
}
.header{
    text-align:center;
    background:white;
    padding:15px;
    box-shadow:0 3px 10px rgba(0,0,0,0.08);
}
.header img{height:80px;}
.header h1{margin:5px;color:#0a4fa3;letter-spacing:2px;}
.header h3{margin:0;font-weight:400;}

.container{padding:20px;}

.filters{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
    gap:15px;
    margin-bottom:25px;
}
.filter-box{display:flex;flex-direction:column;}
.filter-box label{font-size:13px;margin-bottom:6px;font-weight:600;}

select,input{
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
}

.kpi-section{
    display:flex;
    flex-wrap:wrap;
    gap:20px;
    justify-content:center;
    margin-bottom:30px;
}
.kpi{
    background:white;
    width:220px;
    padding:20px;
    text-align:center;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.08);
}
.kpi h4{margin:0;font-size:14px;color:#666;}
.kpi h2{margin:10px 0 0 0;font-size:32px;}

.chart-container{
    width:90%;
    max-width:900px;
    margin:30px auto;
}

.buttons{
    display:flex;
    justify-content:space-between;
    padding:15px 25px;
}

button{
    padding:8px 18px;
    border:none;
    border-radius:6px;
    background:#0a4fa3;
    color:white;
    cursor:pointer;
}

button:hover{background:#083a7a;}

.footer{
    text-align:center;
    padding:15px;
    background:white;
    font-size:14px;
}

.footer a{
    color:#0a4fa3;
    text-decoration:none;
    font-weight:bold;
}

@media print{
    .buttons{display:none;}
    body{background:white;}
}
</style>
</head>

<body>

<div id="dashboard">

<div class="header">
<img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU">
<h1>SADIQ ABBASI HOSPITAL</h1>
<h3>Bahawalpur</h3>
</div>

<div class="container">

<div class="filters">

<div class="filter-box">
<label>From Date</label>
<input type="date" id="fromDate">
</div>

<div class="filter-box">
<label>To Date</label>
<input type="date" id="toDate">
</div>

<div class="filter-box">
<label>District</label>
<select id="district"><option value="">All Districts</option></select>
</div>

<div class="filter-box">
<label>Ward</label>
<select id="ward">
<option>ALL WARDS</option>
<option>GYNAE WARD</option>
<option>PEADS WARD</option>
<option>PEADS EMERGENCY WARD</option>
<option>NICU EMERGENCY</option>
<option>NURSERY (OUT-BORN) WARD</option>
<option>PICU WARD</option>
<option>NICU (IN-BORN) WARD</option>
<option>SURGICAL WARD</option>
<option>ORTHO WARD</option>
<option>MEDICAL WARD</option>
<option>PULMONOLOGY WARD</option>
<option>MEDICAL/SURGICAL ICU WARD</option>
<option>PRIVATE ROOM</option>
<option>ENT WARD</option>
<option>EYE WARD</option>
<option>EMERGENCY WARD</option>
<option>DENGUE WARD</option>
</select>
</div>

<div class="filter-box">
<label>Gender</label>
<select id="gender">
<option>ALL GENDERS</option>
<option>MALE</option>
<option>FEMALE</option>
<option>TRANSGENDER</option>
</select>
</div>

<div class="filter-box">
<label>Age Group</label>
<select id="ageGroup">
<option>ALL AGES</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 Years to 45 Years</option>
<option>45 Years to 60 Years</option>
<option>65 Years & above</option>
</select>
</div>

</div>

<div class="kpi-section">
<div class="kpi"><h4>Total Deaths</h4><h2 id="totalDeaths">0</h2></div>
<div class="kpi"><h4>Total Male Deaths</h4><h2 id="maleDeaths">0</h2></div>
<div class="kpi"><h4>Total Female Deaths</h4><h2 id="femaleDeaths">0</h2></div>
</div>

<div class="chart-container"><canvas id="departmentChart"></canvas></div>
<div class="chart-container"><canvas id="wardChart"></canvas></div>

</div>

<div class="buttons">
<button onclick="exportPDF()">Export to PDF</button>
<button onclick="location.reload()">Reload</button>
</div>

<div class="footer">
Developed By:
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED
</a>
(IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</div>

</div>

<script>

const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData = [];
let deptChart, wardChart;

/* Robust CSV Parser */
function parseCSV(text){
const rows = text.trim().split("\n").map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
const headers = rows.shift().map(h => h.trim().toLowerCase());
return rows.map(row=>{
let obj = {};
headers.forEach((h,i)=>{
obj[h] = row[i] ? row[i].replace(/"/g,"").trim() : "";
});
return obj;
});
}

fetch(sheetURL)
.then(res=>res.text())
.then(text=>{
rawData = parseCSV(text);
populateDistrict();
updateDashboard();
});

/* Populate District */
function populateDistrict(){
let set = new Set();
rawData.forEach(r=>{
if(r["district"]) set.add(r["district"]);
});
let dropdown = document.getElementById("district");
set.forEach(d=>{
let opt=document.createElement("option");
opt.value=d;
opt.textContent=d;
dropdown.appendChild(opt);
});
}

/* Age Matching */
function ageMatch(age,group){
let a=parseFloat(age)||0;
switch(group){
case "Below 30 Days": return a < 0.1;
case "1 Month to 1 Year": return a >=0.1 && a <1;
case "1 Year to 15 Years": return a>=1 && a<=15;
case "15 to 30 Years": return a>15 && a<=30;
case "30 Years to 45 Years": return a>30 && a<=45;
case "45 Years to 60 Years": return a>45 && a<=60;
case "65 Years & above": return a>=65;
default:return true;
}
}

/* Combined Filter */
function getFiltered(){
let from=document.getElementById("fromDate").value;
let to=document.getElementById("toDate").value;
let district=document.getElementById("district").value;
let ward=document.getElementById("ward").value;
let gender=document.getElementById("gender").value;
let ageGroup=document.getElementById("ageGroup").value;

return rawData.filter(r=>{

if(!r["death"] || parseInt(r["death"])<=0) return false;

let recordDate = new Date(r["date"]);
if(from && recordDate < new Date(from)) return false;
if(to && recordDate > new Date(to)) return false;

if(district && r["district"]!==district) return false;
if(ward!=="ALL WARDS" && r["ward"]!==ward) return false;
if(gender!=="ALL GENDERS" && r["gender"]!==gender) return false;
if(ageGroup!=="ALL AGES" && !ageMatch(r["age"],ageGroup)) return false;

return true;
});
}

document.querySelectorAll("select,input").forEach(el=>el.addEventListener("change",updateDashboard));

function updateDashboard(){
let filtered=getFiltered();

document.getElementById("totalDeaths").innerText=filtered.length;
document.getElementById("maleDeaths").innerText=filtered.filter(r=>r["gender"]==="MALE").length;
document.getElementById("femaleDeaths").innerText=filtered.filter(r=>r["gender"]==="FEMALE").length;

drawCharts(filtered);
}

function drawCharts(data){

let deptCounts={}, wardCounts={};

data.forEach(r=>{
deptCounts[r["department"]] = (deptCounts[r["department"]]||0)+1;
wardCounts[r["ward"]] = (wardCounts[r["ward"]]||0)+1;
});

if(deptChart) deptChart.destroy();
if(wardChart) wardChart.destroy();

deptChart=new Chart(document.getElementById("departmentChart"),{
type:"bar",
data:{labels:Object.keys(deptCounts),
datasets:[{data:Object.values(deptCounts),
backgroundColor:["#3498db","#1abc9c","#9b59b6","#e67e22","#e74c3c","#2ecc71"]}]},
options:{plugins:{legend:{display:false}},responsive:true}
});

wardChart=new Chart(document.getElementById("wardChart"),{
type:"bar",
data:{labels:Object.keys(wardCounts),
datasets:[{data:Object.values(wardCounts),
backgroundColor:["#f1c40f","#16a085","#8e44ad","#d35400","#c0392b"]}]},
options:{plugins:{legend:{display:false}},responsive:true}
});
}

/* PDF */
async function exportPDF(){
const { jsPDF }=window.jspdf;
let canvas=await html2canvas(document.querySelector("#dashboard"));
let img=canvas.toDataURL("image/png");
let pdf=new jsPDF("p","mm","a4");
let width=210;
let height=canvas.height*width/canvas.width;
pdf.addImage(img,"PNG",0,0,width,height);
pdf.save("DEATH_DATA_DASHBOARD.pdf");
}

</script>

</body>
</html>
