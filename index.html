<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SADIQ ABBASI HOSPITAL â€“ Mortality Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family: 'Segoe UI', sans-serif;
margin:0;
background:#f4f7fb;
color:#222;
}

header{
text-align:center;
padding:15px;
background:white;
box-shadow:0 2px 10px rgba(0,0,0,0.05);
position:relative;
}

.logo{
height:90px;
}

h1{
margin:5px 0 0;
font-size:22px;
font-weight:600;
}

.clock{
position:absolute;
right:20px;
top:20px;
font-weight:600;
font-size:14px;
color:#0077cc;
}

.container{
padding:20px;
}

.filters{
display:grid;
grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
gap:15px;
margin-bottom:20px;
}

.filter-group{
display:flex;
flex-direction:column;
}

label{
font-size:13px;
margin-bottom:5px;
font-weight:600;
}

select,input{
padding:6px;
border-radius:6px;
border:1px solid #ccc;
}

.kpis{
display:grid;
grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
gap:15px;
margin-bottom:20px;
}

.kpi{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 2px 8px rgba(0,0,0,0.08);
text-align:center;
}

.kpi h2{
margin:5px 0;
font-size:22px;
color:#0077cc;
}

.chart-container{
background:white;
padding:20px;
border-radius:12px;
box-shadow:0 2px 10px rgba(0,0,0,0.08);
max-width:900px;
margin:auto;
}

.buttons{
display:flex;
justify-content:space-between;
margin-top:20px;
}

button{
padding:8px 15px;
border:none;
border-radius:6px;
background:#0077cc;
color:white;
cursor:pointer;
}

button:hover{
background:#005fa3;
}

footer{
text-align:center;
padding:15px;
margin-top:30px;
background:white;
font-size:13px;
}

footer a{
color:#0077cc;
text-decoration:none;
font-weight:600;
}

/* Print A4 Optimization */
@media print{
body{
background:white;
}
.buttons,.clock{
display:none;
}
header,footer{
position:fixed;
width:100%;
}
header{
top:0;
}
footer{
bottom:0;
}
.container{
margin-top:140px;
margin-bottom:80px;
}
}
</style>
</head>

<body>

<header>
<img class="logo" src="https://drive.google.com/uc?id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU">
<h1>SADIQ ABBASI HOSPITAL, BAHAWALPUR<br>Hospital Mortality Dashboard</h1>
<div class="clock" id="clock"></div>
</header>

<div class="container">

<div class="filters">

<div class="filter-group">
<label>From Date</label>
<input type="date" id="fromDate">
</div>

<div class="filter-group">
<label>To Date</label>
<input type="date" id="toDate">
</div>

<div class="filter-group">
<label>Department</label>
<select id="department"><option value="">All</option></select>
</div>

<div class="filter-group">
<label>District</label>
<select id="district"><option value="">All</option></select>
</div>

<div class="filter-group">
<label>Diagnosis</label>
<select id="diagnosis"><option value="">All</option></select>
</div>

<div class="filter-group">
<label>Gender</label>
<select id="gender"><option value="">All</option></select>
</div>

<div class="filter-group">
<label>Age Group</label>
<select id="ageGroup">
<option value="">All</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 Years to 45 Years</option>
<option>45 Years to 60 Years</option>
<option>65 Years & above</option>
</select>
</div>

</div>

<div class="kpis">
<div class="kpi">
<h3>Total Deaths</h3>
<h2 id="totalDeaths">0</h2>
</div>
<div class="kpi">
<h3>Total Male Deaths</h3>
<h2 id="maleDeaths">0</h2>
</div>
<div class="kpi">
<h3>Total Female Deaths</h3>
<h2 id="femaleDeaths">0</h2>
</div>
</div>

<div class="chart-container">
<canvas id="deptChart"></canvas>
</div>

<div class="buttons">
<button onclick="exportPDF()">Export to PDF</button>
<button onclick="location.reload()">Refresh</button>
</div>

</div>

<footer>
Developed By: <a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED</a>
(IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</footer>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[];
let chart;

async function loadData(){
const res=await fetch(csvUrl);
const text=await res.text();
const rows=text.split("\n").map(r=>r.split(","));
const headers=rows[0];

const DATE=headers.indexOf("DATE");
const DEPT=8;
const GENDER=6;
const DIAG=20;
const DIST=21;
const AGE=5;

rawData=rows.slice(1).map(r=>({
date:new Date(r[DATE]),
dept:r[DEPT],
gender:r[GENDER],
diag:r[DIAG],
dist:r[DIST],
age:parseFloat(r[AGE])
}));

populateDropdown("department",[...new Set(rawData.map(r=>r.dept).filter(Boolean))]);
populateDropdown("district",[...new Set(rawData.map(r=>r.dist).filter(Boolean))]);
populateDropdown("diagnosis",[...new Set(rawData.map(r=>r.diag).filter(Boolean))]);
populateDropdown("gender",[...new Set(rawData.map(r=>r.gender).filter(Boolean))]);

applyFilters();
}

function populateDropdown(id,values){
const sel=document.getElementById(id);
values.sort().forEach(v=>{
const opt=document.createElement("option");
opt.value=v;
opt.textContent=v;
sel.appendChild(opt);
});
}

function getFiltered(){
let data=rawData;

const fDate=new Date(document.getElementById("fromDate").value);
const tDate=new Date(document.getElementById("toDate").value);

if(document.getElementById("fromDate").value)
data=data.filter(r=>r.date>=fDate);

if(document.getElementById("toDate").value)
data=data.filter(r=>r.date<=tDate);

["department","district","diagnosis","gender"].forEach(id=>{
const val=document.getElementById(id).value;
if(val) data=data.filter(r=>r[id==="department"?"dept":id==="district"?"dist":id==="diagnosis"?"diag":"gender"]===val);
});

const ageGroup=document.getElementById("ageGroup").value;
if(ageGroup){
data=data.filter(r=>{
if(isNaN(r.age)) return false;
if(ageGroup==="Below 30 Days") return r.age<0.1;
if(ageGroup==="1 Month to 1 Year") return r.age>=0.1 && r.age<1;
if(ageGroup==="1 Year to 15 Years") return r.age>=1 && r.age<15;
if(ageGroup==="15 to 30 Years") return r.age>=15 && r.age<30;
if(ageGroup==="30 Years to 45 Years") return r.age>=30 && r.age<45;
if(ageGroup==="45 Years to 60 Years") return r.age>=45 && r.age<60;
if(ageGroup==="65 Years & above") return r.age>=65;
});
}

return data;
}

function applyFilters(){
const data=getFiltered();

document.getElementById("totalDeaths").innerText=data.length;
document.getElementById("maleDeaths").innerText=data.filter(r=>r.gender==="Male").length;
document.getElementById("femaleDeaths").innerText=data.filter(r=>r.gender==="Female").length;

const grouped={};
data.forEach(r=>{
grouped[r.dept]=(grouped[r.dept]||0)+1;
});

const labels=Object.keys(grouped);
const values=Object.values(grouped);

if(chart) chart.destroy();

chart=new Chart(document.getElementById("deptChart"),{
type:"bar",
data:{
labels:labels,
datasets:[{
data:values,
backgroundColor:labels.map(()=>`hsl(${Math.random()*360},70%,60%)`)
}]
},
options:{
responsive:true,
plugins:{
legend:{display:false}
}
}
});
}

document.querySelectorAll("select,input").forEach(el=>el.addEventListener("change",applyFilters));

function updateClock(){
const now=new Date();
document.getElementById("clock").innerText=now.toLocaleString();
}
setInterval(updateClock,1000);
updateClock();

async function exportPDF(){
const {jsPDF}=window.jspdf;
const canvas=await html2canvas(document.body);
const imgData=canvas.toDataURL("image/png");
const pdf=new jsPDF("p","mm","a4");
const imgWidth=210;
const imgHeight=(canvas.height*imgWidth)/canvas.width;
pdf.addImage(imgData,"PNG",0,0,imgWidth,imgHeight);
pdf.save("Hospital_Mortality_Dashboard.pdf");
}

loadData();

</script>
</body>
</html>
