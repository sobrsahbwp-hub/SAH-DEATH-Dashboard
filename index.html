<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hospital Mortality Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{font-family:Segoe UI;margin:0;background:#f4f7fb;}
.header{text-align:center;padding:20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.header img{height:80px;}
.container{padding:20px;}
.filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;}
.filter-box{display:flex;flex-direction:column;}
.filter-box label{font-weight:600;margin-bottom:5px;}
select,input{padding:8px;border-radius:6px;border:1px solid #ccc;}
.kpis{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;}
.kpi{flex:1;min-width:200px;background:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.kpi h3{margin:0;font-size:16px;}
.kpi p{font-size:28px;font-weight:bold;margin-top:10px;color:#0a3d62;}
.chart-container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.buttons{display:flex;justify-content:space-between;margin-top:20px;}
button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
.pdf-btn{background:#0a3d62;color:white;}
.refresh-btn{background:#16a085;color:white;}
.footer{text-align:center;padding:15px;font-size:14px;}
@media print{.buttons{display:none;}}
@page{size:A4;margin:10mm;}
</style>
</head>

<body>

<div id="dashboard">

<div class="header">
<img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU">
<h2>SADIQ ABBASI HOSPITAL, BAHAWALPUR</h2>
<h3>Mortality Dashboard</h3>
</div>

<div class="container">

<div class="filters">
<div class="filter-box"><label>From Date</label><input type="date" id="fromDate"></div>
<div class="filter-box"><label>To Date</label><input type="date" id="toDate"></div>
<div class="filter-box"><label>DEPARTMENT</label><select id="department"></select></div>
<div class="filter-box"><label>DISTRICT</label><select id="district"></select></div>
<div class="filter-box"><label>DIAGNOSIS</label><select id="diagnosis"></select></div>
<div class="filter-box"><label>GENDER</label><select id="gender"></select></div>
<div class="filter-box">
<label>AGE GROUP</label>
<select id="ageGroup">
<option value="">All</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 Years to 45 Years</option>
<option>45 Years to 60 Years</option>
<option>65 Years & above</option>
</select>
</div>
</div>

<div class="kpis">
<div class="kpi"><h3>Total Deaths</h3><p id="totalDeaths">0</p></div>
<div class="kpi"><h3>Total Male Deaths</h3><p id="maleDeaths">0</p></div>
<div class="kpi"><h3>Total Female Deaths</h3><p id="femaleDeaths">0</p></div>
</div>

<div class="chart-container">
<canvas id="deptChart"></canvas>
</div>

<div class="buttons">
<button class="pdf-btn" onclick="exportPDF()">Export to PDF</button>
<button class="refresh-btn" onclick="location.reload()">Refresh</button>
</div>

</div>

<div class="footer">
Developed By:
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED
</a>
(IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</div>

</div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[];
let chart;

// Parse Date safely (handles DD/MM/YYYY)
function parseDate(value){
    if(!value) return null;
    if(value.includes("/")){
        let parts=value.split("/");
        if(parts[2].length===4){
            return new Date(parts[2],parts[1]-1,parts[0]);
        }
    }
    return new Date(value);
}

// Normalize gender values
function normalizeGender(g){
    if(!g) return "";
    g=g.trim().toLowerCase();
    if(g==="m"||g==="male") return "Male";
    if(g==="f"||g==="female") return "Female";
    return g;
}

// Convert Age text â†’ Years decimal
function parseAge(ageText){
    if(!ageText) return 0;
    ageText=ageText.toLowerCase();
    let years=0,months=0,days=0;

    let y=ageText.match(/(\d+)\s*year/);
    let m=ageText.match(/(\d+)\s*month/);
    let d=ageText.match(/(\d+)\s*day/);

    if(y) years=parseInt(y[1]);
    if(m) months=parseInt(m[1]);
    if(d) days=parseInt(d[1]);

    return years+(months/12)+(days/365);
}

Papa.parse(csvUrl,{
    download:true,
    skipEmptyLines:true,
    complete:function(results){
        rawData=results.data.slice(1);
        populateDropdown(8,"department");
        populateDropdown(21,"district");
        populateDropdown(20,"diagnosis");
        populateDropdown(6,"gender",true);
        applyFilters();
    }
});

function populateDropdown(index,id,isGender=false){
    const dropdown=document.getElementById(id);
    dropdown.innerHTML="<option value=''>All</option>";
    let values=rawData.map(r=>r[index]).filter(v=>v);
    if(isGender) values=values.map(v=>normalizeGender(v));
    const unique=[...new Set(values)];
    unique.sort().forEach(val=>{
        dropdown.innerHTML+=`<option value="${val}">${val}</option>`;
    });
}

document.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change",applyFilters);
});

function ageMatch(age,group){
    if(!group) return true;
    if(group==="Below 30 Days") return age<(30/365);
    if(group==="1 Month to 1 Year") return age>=(1/12)&&age<1;
    if(group==="1 Year to 15 Years") return age>=1&&age<=15;
    if(group==="15 to 30 Years") return age>15&&age<=30;
    if(group==="30 Years to 45 Years") return age>30&&age<=45;
    if(group==="45 Years to 60 Years") return age>45&&age<=60;
    if(group==="65 Years & above") return age>=65;
    return true;
}

function applyFilters(){

    const from=document.getElementById("fromDate").value;
    const to=document.getElementById("toDate").value;
    const dept=department.value;
    const dist=district.value;
    const diag=diagnosis.value;
    const gender=document.getElementById("gender").value;
    const ageGroup=document.getElementById("ageGroup").value;

    let filtered=rawData.filter(r=>{

        const deathDate=parseDate(r[17]);
        const rowGender=normalizeGender(r[6]);
        const age=parseAge(r[3]);

        return (!from||deathDate>=new Date(from)) &&
               (!to||deathDate<=new Date(to)) &&
               (!dept||r[8]===dept) &&
               (!dist||r[21]===dist) &&
               (!diag||r[20]===diag) &&
               (!gender||rowGender===gender) &&
               ageMatch(age,ageGroup);
    });

    document.getElementById("totalDeaths").innerText=filtered.length;
    document.getElementById("maleDeaths").innerText=filtered.filter(r=>normalizeGender(r[6])==="Male").length;
    document.getElementById("femaleDeaths").innerText=filtered.filter(r=>normalizeGender(r[6])==="Female").length;

    const deptCounts={};
    filtered.forEach(r=>{
        const d=r[8]||"Unknown";
        deptCounts[d]=(deptCounts[d]||0)+1;
    });

    if(chart) chart.destroy();

    chart=new Chart(document.getElementById("deptChart"),{
        type:"bar",
        data:{
            labels:Object.keys(deptCounts),
            datasets:[{
                data:Object.values(deptCounts),
                backgroundColor:[
                    "#3498db","#e74c3c","#2ecc71","#9b59b6",
                    "#f39c12","#1abc9c","#34495e","#e67e22"
                ]
            }]
        },
        options:{responsive:true,plugins:{legend:{display:false}}}
    });
}

function exportPDF(){
    html2pdf().from(document.getElementById("dashboard")).set({
        margin:10,
        filename:"Mortality_Dashboard.pdf",
        html2canvas:{scale:2},
        jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
    }).save();
}

</script>

</body>
</html>
