<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sadiq Abbasi Hospital - Mortality Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Segoe UI,sans-serif;background:#f4f7fb;}
.header{text-align:center;padding:20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.header img{height:80px;margin-bottom:10px;}
.container{padding:20px;}
.filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;}
.filter-box{display:flex;flex-direction:column;}
.filter-box label{font-weight:600;margin-bottom:5px;font-size:14px;}
select,input{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
.kpis{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;justify-content:center;}
.kpi{flex:1;min-width:150px;background:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.kpi h3{margin:0;font-size:16px;color:#555;}
.kpi p{font-size:28px;font-weight:bold;margin-top:10px;color:#0a3d62;}
.chart-container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:20px;}
.buttons{display:flex;justify-content:space-between;margin-top:10px;}
button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;}
.pdf-btn{background:#0a3d62;color:white;}
.refresh-btn{background:#16a085;color:white;}
.footer{text-align:center;padding:15px;font-size:14px;color:#555;}
.footer a{text-decoration:none;color:#0a3d62;font-weight:600;}
</style>
</head>
<body>

<div id="dashboard">

<div class="header">
<img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU">
<h2>SADIQ ABBASI HOSPITAL, BAHAWALPUR</h2>
<h3>Mortality Dashboard</h3>
</div>

<div class="container">

<div class="filters">
<div class="filter-box"><label>From Date</label><input type="date" id="fromDate"></div>
<div class="filter-box"><label>To Date</label><input type="date" id="toDate"></div>
<div class="filter-box"><label>Department</label><select id="department"></select></div>
<div class="filter-box"><label>District</label><select id="district"></select></div>
<div class="filter-box"><label>Diagnosis</label><select id="diagnosis"></select></div>
<div class="filter-box"><label>Gender</label><select id="gender"></select></div>
</div>

<div class="kpis">
<div class="kpi"><h3>Total Deaths</h3><p id="totalDeaths">0</p></div>
<div class="kpi"><h3>Total Male Deaths</h3><p id="maleDeaths">0</p></div>
<div class="kpi"><h3>Total Female Deaths</h3><p id="femaleDeaths">0</p></div>
</div>

<div class="chart-container">
<canvas id="deptChart"></canvas>
</div>

<div class="buttons">
<button class="pdf-btn" onclick="exportPDF()">Export PDF</button>
<button class="refresh-btn" onclick="loadData()">Refresh</button>
</div>

</div>

<div class="footer">
Developed By: <a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED</a>
</div>

</div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[];
let chart;

/* ===== DATE PARSER ===== */
function parseDate(value){
    if(!value) return null;
    if(value.includes("/")){
        const p=value.split("/");
        return new Date(p[2],p[1]-1,p[0]);
    }
    return new Date(value);
}

/* ===== GENDER NORMALIZER ===== */
function normalizeGender(g){
    if(!g) return "";
    g=g.toLowerCase().trim();
    if(g==="m") return "Male";
    if(g==="f") return "Female";
    return g.charAt(0).toUpperCase()+g.slice(1);
}

/* ===== POPULATE DROPDOWN ===== */
function populateDropdown(column,id,isGender=false){
    const select=document.getElementById(id);
    select.innerHTML="<option value=''>All</option>";

    let values=rawData.map(r=>r[column]).filter(v=>v);

    if(isGender) values=values.map(v=>normalizeGender(v));

    const unique=[...new Set(values.map(v=>v.trim()))].sort();

    unique.forEach(v=>{
        const opt=document.createElement("option");
        opt.value=v;
        opt.textContent=v;
        select.appendChild(opt);
    });
}

/* ===== APPLY FILTERS ===== */
function applyFilters(){

    const from=document.getElementById("fromDate").value;
    const to=document.getElementById("toDate").value;
    const dept=document.getElementById("department").value;
    const dist=document.getElementById("district").value;
    const diag=document.getElementById("diagnosis").value;
    const gender=document.getElementById("gender").value;

    const fromDate=from?new Date(from):null;
    const toDate=to?new Date(to):null;

    const filtered=rawData.filter(r=>{

        const deathDate=parseDate(r["Date of Death"]);
        const rowGender=normalizeGender(r["Gender"]);

        if(fromDate && (!deathDate || deathDate<fromDate)) return false;
        if(toDate && (!deathDate || deathDate>toDate)) return false;

        if(dept && r["Department"]?.trim()!==dept) return false;
        if(dist && r["District"]?.trim()!==dist) return false;
        if(diag && r["Diagnosis"]?.trim()!==diag) return false;
        if(gender && rowGender!==gender) return false;

        return true;
    });

    document.getElementById("totalDeaths").innerText=filtered.length;
    document.getElementById("maleDeaths").innerText=
        filtered.filter(r=>normalizeGender(r["Gender"])==="Male").length;
    document.getElementById("femaleDeaths").innerText=
        filtered.filter(r=>normalizeGender(r["Gender"])==="Female").length;

    const deptCounts={};
    filtered.forEach(r=>{
        const d=r["Department"]||"Unknown";
        deptCounts[d]=(deptCounts[d]||0)+1;
    });

    if(chart) chart.destroy();

    chart=new Chart(document.getElementById("deptChart"),{
        type:"bar",
        data:{
            labels:Object.keys(deptCounts),
            datasets:[{
                data:Object.values(deptCounts),
                backgroundColor:"#0a3d62"
            }]
        },
        options:{
            responsive:true,
            scales:{y:{beginAtZero:true}},
            plugins:{legend:{display:false}}
        }
    });
}

/* ===== LOAD DATA ===== */
function loadData(){
    Papa.parse(csvUrl,{
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:function(res){
            rawData=res.data;
            populateDropdown("Department","department");
            populateDropdown("District","district");
            populateDropdown("Diagnosis","diagnosis");
            populateDropdown("Gender","gender",true);
            applyFilters();
        }
    });
}

/* ===== PDF EXPORT ===== */
function exportPDF(){
    html2pdf().from(document.getElementById("dashboard")).set({
        margin:10,
        filename:"Mortality_Dashboard.pdf",
        html2canvas:{scale:2},
        jsPDF:{unit:"mm",format:"a4"}
    }).save();
}

/* ===== INIT ===== */
loadData();
document.querySelectorAll("select,input")
.forEach(el=>el.addEventListener("change",applyFilters));

</script>
</body>
</html>
