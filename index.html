<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SADIQ ABBASI HOSPITAL, BAHAWALPUR (Mortality Data Dashboard)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    margin:0;
    font-family:Segoe UI, Arial, sans-serif;
    background:#f5f8fc;
}

header{
    background:#ffffff;
    padding:20px;
    text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
    position:relative;
}

header h2{
    margin:0;
    font-size:22px;
    color:#1f2d3d;
}

#clock{
    position:absolute;
    right:20px;
    top:20px;
    font-weight:600;
    color:#2c3e50;
}

.container{
    padding:20px;
}

.filters{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:20px;
    margin-bottom:25px;
}

.filter-group{
    display:flex;
    flex-direction:column;
}

label{
    font-weight:600;
    margin-bottom:6px;
}

select,input{
    padding:8px;
    border:1px solid #d0d7e2;
    border-radius:6px;
}

.kpis{
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    margin-bottom:30px;
}

.kpi{
    flex:1;
    min-width:220px;
    background:#ffffff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
    text-align:center;
}

.kpi h3{
    margin:0;
    font-size:15px;
    color:#5c6b7a;
}

.kpi h2{
    margin-top:10px;
    font-size:28px;
    color:#1f2d3d;
}

.charts{
    display:flex;
    flex-wrap:wrap;
    gap:30px;
    justify-content:center;
}

.chart-box{
    flex:1;
    min-width:320px;
    max-width:600px;
    background:#ffffff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
}

canvas{
    width:100% !important;
    height:350px !important;
}

.buttons{
    display:flex;
    justify-content:space-between;
    margin-top:30px;
    flex-wrap:wrap;
}

button{
    padding:10px 18px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
}

.pdf-btn{ background:#007bff; color:white;}
.refresh-btn{ background:#28a745; color:white;}

.footer{
    margin-top:30px;
    padding:15px;
    text-align:center;
    font-size:14px;
    background:#ffffff;
}

@media(max-width:768px){
    .charts{flex-direction:column;}
}
</style>
</head>

<body>

<header>
<h2>SADIQ ABBASI HOSPITAL, BAHAWALPUR (Mortality Data Dashboard)</h2>
<div id="clock"></div>
</header>

<div class="container">

<div class="filters">
<div class="filter-group">
<label>From Date</label>
<input type="date" id="fromDate">
</div>

<div class="filter-group">
<label>To Date</label>
<input type="date" id="toDate">
</div>

<div class="filter-group">
<label>DEPARTMENT</label>
<select id="department"></select>
</div>

<div class="filter-group">
<label>DISTRICT</label>
<select id="district"></select>
</div>

<div class="filter-group">
<label>DIAGNOSIS</label>
<select id="diagnosis"></select>
</div>

<div class="filter-group">
<label>GENDER</label>
<select id="gender"></select>
</div>

<div class="filter-group">
<label>AGE GROUP</label>
<select id="ageGroup">
<option value="">All</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 Years to 45 Years</option>
<option>45 Years to 60 Years</option>
<option>65 Years & above</option>
</select>
</div>
</div>

<div class="kpis">
<div class="kpi"><h3>Total Deaths</h3><h2 id="totalDeaths">0</h2></div>
<div class="kpi"><h3>Total Male Deaths</h3><h2 id="maleDeaths">0</h2></div>
<div class="kpi"><h3>Total Female Deaths</h3><h2 id="femaleDeaths">0</h2></div>
</div>

<div class="charts">
<div class="chart-box">
<canvas id="deptChart"></canvas>
</div>
<div class="chart-box">
<canvas id="districtChart"></canvas>
</div>
</div>

<div class="buttons">
<button class="pdf-btn" onclick="generatePDF()">Executive PDF Summary</button>
<button class="refresh-btn" onclick="location.reload()">Refresh</button>
</div>

</div>

<div class="footer">
Developed By: 
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED (IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</a>
</div>

<script>

const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[];
let deptChart,districtChart;

/* ---------------- CLOCK ---------------- */
function updateClock(){
document.getElementById("clock").innerText=new Date().toLocaleString();
}
setInterval(updateClock,1000);

/* ---------------- LOAD DATA ---------------- */
Papa.parse(sheetURL,{
download:true,
header:true,
skipEmptyLines:true,
complete:function(results){
rawData=results.data.filter(row=>row["DATE"]);
populateDropdowns();
applyFilters();
}
});

/* ---------------- DROPDOWNS ---------------- */
function populateDropdowns(){
["DEPARTMENT","DISTRICT","DIAGNOSIS","GENDER"].forEach(field=>{
let select=document.getElementById(field.toLowerCase());
select.innerHTML="<option value=''>All</option>";
[...new Set(rawData.map(r=>r[field]).filter(Boolean))]
.sort()
.forEach(val=>{
select.innerHTML+=`<option>${val}</option>`;
});
});
}

/* ---------------- AGE GROUP ---------------- */
function getAgeGroup(age){
age=parseFloat(age);
if(isNaN(age)) return "";
if(age<0.1) return "Below 30 Days";
if(age<1) return "1 Month to 1 Year";
if(age<15) return "1 Year to 15 Years";
if(age<30) return "15 to 30 Years";
if(age<45) return "30 Years to 45 Years";
if(age<60) return "45 Years to 60 Years";
if(age>=65) return "65 Years & above";
return "";
}

/* ---------------- FILTER ---------------- */
function applyFilters(){

let from=document.getElementById("fromDate").value;
let to=document.getElementById("toDate").value;

let filtered=rawData.filter(row=>{

let rowDate=new Date(row["DATE"]);
if(from && rowDate < new Date(from)) return false;
if(to && rowDate > new Date(to)) return false;

if(department.value && row["DEPARTMENT"]!==department.value) return false;
if(district.value && row["DISTRICT"]!==district.value) return false;
if(diagnosis.value && row["DIAGNOSIS"]!==diagnosis.value) return false;
if(gender.value && row["GENDER"]!==gender.value) return false;
if(ageGroup.value && getAgeGroup(row["AGE"])!==ageGroup.value) return false;

return true;
});

updateKPIs(filtered);
drawCharts(filtered);
}

/* ---------------- KPI ---------------- */
function updateKPIs(data){
document.getElementById("totalDeaths").innerText=data.length;
document.getElementById("maleDeaths").innerText=data.filter(d=>d.GENDER?.toLowerCase()==="male").length;
document.getElementById("femaleDeaths").innerText=data.filter(d=>d.GENDER?.toLowerCase()==="female").length;
}

/* ---------------- GROUP DATA ---------------- */
function groupAndSort(data,key){

let obj={};
data.forEach(r=>{
let val=r[key]||"Unknown";
obj[val]=(obj[val]||0)+1;
});

let sorted=Object.entries(obj)
.sort((a,b)=>b[1]-a[1]);

return {
labels: sorted.map(item=>item[0]),
values: sorted.map(item=>item[1])
};
}

/* ---------------- RANDOM COLOR GENERATOR ---------------- */
function generateColors(count){
const colors=[];
for(let i=0;i<count;i++){
colors.push(`hsl(${Math.random()*360},70%,55%)`);
}
return colors;
}

/* ---------------- BAR VALUE LABEL PLUGIN ---------------- */
const barValuePlugin={
id:'barValuePlugin',
afterDatasetsDraw(chart){

const {ctx}=chart;
ctx.save();

chart.data.datasets.forEach((dataset,i)=>{
chart.getDatasetMeta(i).data.forEach((bar,index)=>{

let value=dataset.data[index];

ctx.fillStyle="#000";
ctx.font="bold 12px Arial";
ctx.textAlign="center";
ctx.fillText(value, bar.x, bar.y - 5);

});
});

ctx.restore();
}
};

/* ---------------- DRAW CHARTS ---------------- */
function drawCharts(data){

if(deptChart){
deptChart.destroy();
deptChart=null;
}

if(districtChart){
districtChart.destroy();
districtChart=null;
}

/* ----- WARD / DEPARTMENT ----- */
let deptData=groupAndSort(data,"DEPARTMENT");
let deptColors=generateColors(deptData.labels.length);

deptChart=new Chart(document.getElementById("deptChart"),{
type:"bar",
data:{
labels:deptData.labels,
datasets:[{
label:"Deaths by Ward",
data:deptData.values,
backgroundColor:deptColors,
borderRadius:6
}]
},
options:{
responsive:true,
plugins:{legend:{display:false}},
scales:{
y:{beginAtZero:true}
}
},
plugins:[barValuePlugin]
});

/* ----- DISTRICT ----- */
let districtData=groupAndSort(data,"DISTRICT");
let districtColors=generateColors(districtData.labels.length);

districtChart=new Chart(document.getElementById("districtChart"),{
type:"bar",
data:{
labels:districtData.labels,
datasets:[{
label:"Deaths by District",
data:districtData.values,
backgroundColor:districtColors,
borderRadius:6
}]
},
options:{
responsive:true,
plugins:{legend:{display:false}},
scales:{
y:{beginAtZero:true}
}
},
plugins:[barValuePlugin]
});

}

/* ---------------- EVENT LISTENERS ---------------- */
document.querySelectorAll("select,input").forEach(el=>{
el.addEventListener("change",applyFilters);
});

/* ---------------- PDF ---------------- */
async function generatePDF(){
const { jsPDF } = window.jspdf;
let doc=new jsPDF();
doc.text("SADIQ ABBASI HOSPITAL, BAHAWALPUR",20,20);
doc.text("Mortality Executive Summary",20,30);
doc.text("Total Deaths: "+totalDeaths.innerText,20,50);
doc.text("Male Deaths: "+maleDeaths.innerText,20,60);
doc.text("Female Deaths: "+femaleDeaths.innerText,20,70);
doc.save("Mortality_Summary.pdf");
}

</script>

</body>
</html>
