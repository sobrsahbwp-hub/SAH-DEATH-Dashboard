<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sadiq Abbasi Hospital - Mortality Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Segoe UI,sans-serif;background:#f4f7fb;}
.header{position:relative;text-align:center;padding:20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.header img{height:80px;margin-bottom:10px;}
#clock{position:absolute;top:20px;right:20px;font-weight:600;font-size:14px;color:#34495e;}
.container{padding:20px;}
.filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;}
.filter-box{display:flex;flex-direction:column;}
.filter-box label{font-weight:600;margin-bottom:5px;font-size:14px;}
select,input{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
.kpis{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;justify-content:center;}
.kpi{flex:1;min-width:150px;background:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.kpi h3{margin:0;font-size:16px;color:#555;}
.kpi p{font-size:28px;font-weight:bold;margin-top:10px;color:#0a3d62;}
.chart-container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:20px;}
.buttons{display:flex;justify-content:space-between;margin-top:10px;}
button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;}
.pdf-btn{background:#0a3d62;color:white;}
.refresh-btn{background:#16a085;color:white;}
.footer{text-align:center;padding:15px;font-size:14px;color:#555;}
.footer a{text-decoration:none;color:#0a3d62;font-weight:600;}
@media print{.buttons,#clock{display:none;}}
@page{size:A4;margin:10mm;}
</style>
</head>
<body>

<div id="dashboard">

<div class="header">
<img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU" alt="Hospital Logo">
<h2>SADIQ ABBASI HOSPITAL, BAHAWALPUR</h2>
<h3>Mortality Dashboard</h3>
<div id="clock"></div>
</div>

<div class="container">

<!-- Filters -->
<div class="filters">
<div class="filter-box"><label>From Date</label><input type="date" id="fromDate"></div>
<div class="filter-box"><label>To Date</label><input type="date" id="toDate"></div>
<div class="filter-box"><label>DEPARTMENT</label><select id="department"></select></div>
<div class="filter-box"><label>DISTRICT</label><select id="district"></select></div>
<div class="filter-box"><label>DIAGNOSIS</label><select id="diagnosis"></select></div>
<div class="filter-box"><label>GENDER</label><select id="gender"></select></div>
<div class="filter-box"><label>AGE GROUP</label>
<select id="ageGroup">
<option value="">All</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 to 45 Years</option>
<option>45 to 60 Years</option>
<option>65 Years & above</option>
</select></div>
</div>

<!-- KPIs -->
<div class="kpis">
<div class="kpi"><h3>Total Deaths</h3><p id="totalDeaths">0</p></div>
<div class="kpi"><h3>Total Male Deaths</h3><p id="maleDeaths">0</p></div>
<div class="kpi"><h3>Total Female Deaths</h3><p id="femaleDeaths">0</p></div>
</div>

<!-- Chart -->
<div class="chart-container">
<canvas id="deptChart"></canvas>
</div>

<!-- Buttons -->
<div class="buttons">
<button class="pdf-btn" onclick="exportPDF()">Export to PDF</button>
<button class="refresh-btn" onclick="fetchData()">Refresh</button>
</div>

</div>

<!-- Footer -->
<div class="footer">
Developed By: <a href="https://www.linkedin.com/in/smus79" target="_blank">Software Engineer MUHAMMAD UMAIR SYED</a> (IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</div>

</div>

<script>
const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[];
let chart;

/* ================= CLOCK ================= */
function updateClock(){
    document.getElementById("clock").innerText=new Date().toLocaleString();
}
setInterval(updateClock,1000);
updateClock();

/* ================= SAFE DATE PARSER ================= */
function parseDate(value){
    if(!value) return null;
    value=value.trim();

    // DD/MM/YYYY
    if(value.includes("/")){
        const parts=value.split("/");
        if(parts.length===3){
            return new Date(parts[2],parts[1]-1,parts[0]);
        }
    }

    // YYYY-MM-DD
    if(value.includes("-")){
        return new Date(value);
    }

    return null;
}

/* ================= GENDER NORMALIZATION ================= */
function normalizeGender(g){
    if(!g) return "";
    g=g.trim().toLowerCase();
    if(g==="m"||g==="male") return "Male";
    if(g==="f"||g==="female") return "Female";
    return g.charAt(0).toUpperCase()+g.slice(1);
}

/* ================= AGE PARSER ================= */
function parseAge(ageText){
    if(!ageText) return 0;
    ageText=ageText.toLowerCase();

    let years=0,months=0,days=0;

    const y=ageText.match(/(\d+)\s*year/);
    const m=ageText.match(/(\d+)\s*month/);
    const d=ageText.match(/(\d+)\s*day/);

    if(y) years=parseInt(y[1]);
    if(m) months=parseInt(m[1]);
    if(d) days=parseInt(d[1]);

    return years + (months/12) + (days/365);
}

/* ================= AGE GROUP FILTER ================= */
function ageMatch(age,group){
    if(!group) return true;

    switch(group){
        case "Below 30 Days": return age < (30/365);
        case "1 Month to 1 Year": return age >= (1/12) && age < 1;
        case "1 Year to 15 Years": return age >=1 && age <=15;
        case "15 to 30 Years": return age >15 && age <=30;
        case "30 to 45 Years": return age >30 && age <=45;
        case "45 to 60 Years": return age >45 && age <=60;
        case "65 Years & above": return age >=65;
        default: return true;
    }
}

/* ================= POPULATE DROPDOWN ================= */
function populateDropdown(columnName,id,isGender=false){

    const dropdown=document.getElementById(id);
    dropdown.innerHTML="<option value=''>All</option>";

    let values=rawData.map(r=>r[columnName]).filter(v=>v && v.trim()!=="");

    if(isGender){
        values=values.map(v=>normalizeGender(v));
    }

    const unique=[...new Set(values.map(v=>v.trim()))].sort();

    unique.forEach(v=>{
        const option=document.createElement("option");
        option.value=v;
        option.textContent=v;
        dropdown.appendChild(option);
    });
}

/* ================= MAIN FILTER FUNCTION ================= */
function applyFilters(){

    const from=document.getElementById("fromDate").value;
    const to=document.getElementById("toDate").value;
    const dept=document.getElementById("department").value;
    const dist=document.getElementById("district").value;
    const diag=document.getElementById("diagnosis").value;
    const gender=document.getElementById("gender").value;
    const ageGroup=document.getElementById("ageGroup").value;

    const fromDate=from ? new Date(from) : null;
    const toDate=to ? new Date(to) : null;

    const filtered=rawData.filter(r=>{

        const deathDate=parseDate(r["Date of Death"]);
        const rowGender=normalizeGender(r["Gender"]);
        const age=parseAge(r["Age"]);

        if(fromDate && (!deathDate || deathDate<fromDate)) return false;
        if(toDate && (!deathDate || deathDate>toDate)) return false;

        if(dept && r["Department"]?.trim()!==dept) return false;
        if(dist && r["District"]?.trim()!==dist) return false;
        if(diag && r["Diagnosis"]?.trim()!==diag) return false;
        if(gender && rowGender!==gender) return false;
        if(!ageMatch(age,ageGroup)) return false;

        return true;
    });

    /* ===== KPI UPDATE ===== */
    document.getElementById("totalDeaths").innerText=filtered.length;
    document.getElementById("maleDeaths").innerText=
        filtered.filter(r=>normalizeGender(r["Gender"])==="Male").length;
    document.getElementById("femaleDeaths").innerText=
        filtered.filter(r=>normalizeGender(r["Gender"])==="Female").length;

    /* ===== CHART UPDATE ===== */
    const deptCounts={};
    filtered.forEach(r=>{
        const d=r["Department"]?.trim()||"Unknown";
        deptCounts[d]=(deptCounts[d]||0)+1;
    });

    if(chart) chart.destroy();

    chart=new Chart(document.getElementById("deptChart"),{
        type:"bar",
        data:{
            labels:Object.keys(deptCounts),
            datasets:[{
                label:"Deaths",
                data:Object.values(deptCounts),
                backgroundColor:"#0a3d62"
            }]
        },
        options:{
            responsive:true,
            scales:{y:{beginAtZero:true}},
            plugins:{legend:{display:false}}
        }
    });
}

/* ================= FETCH DATA ================= */
function fetchData(){
    Papa.parse(csvUrl,{
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:function(results){

            rawData=results.data;

            populateDropdown("Department","department");
            populateDropdown("District","district");
            populateDropdown("Diagnosis","diagnosis");
            populateDropdown("Gender","gender",true);

            applyFilters();
        }
    });
}

/* ================= INITIAL LOAD ================= */
fetchData();
document.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change",applyFilters);
});
</script>

// Export PDF
function exportPDF(){
    html2pdf().from(document.getElementById("dashboard")).set({
        margin:10,
        filename:"Mortality_Dashboard.pdf",
        html2canvas:{scale:2},
        jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
    }).save();
}

// Fetch CSV data from Google Sheets
function fetchData(){
    Papa.parse(csvUrl,{
        download:true,
        skipEmptyLines:true,
        header:true,
        complete:function(results){
            rawData=results.data;
            populateDropdown("Department","department");
            populateDropdown("District","district");
            populateDropdown("Diagnosis","diagnosis");
            populateDropdown("Gender","gender",true);
            applyFilters();
        }
    });
}

// Initial Load
fetchData();
document.querySelectorAll("select,input").forEach(el=>el.addEventListener("change",applyFilters));

</script>
</body>
</html>
