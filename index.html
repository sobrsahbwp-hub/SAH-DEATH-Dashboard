<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sadiq Abbasi Hospital – Mortality Dashboard</title>

<!-- CSS -->
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f9f9f9;
    margin: 0;
    padding: 0;
    color: #333;
  }
  header {
    text-align: center;
    padding: 20px;
    background-color: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  header img {
    max-width: 150px;
    height: auto;
    display: block;
    margin: 0 auto 10px auto;
  }
  header h1 {
    margin: 0;
    font-size: 24px;
    color: #2c3e50;
  }
  .filters {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin: 20px;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  .filter-group label {
    margin-bottom: 5px;
    font-weight: bold;
  }
  select, input[type="date"] {
    padding: 5px 8px;
    font-size: 14px;
  }
  .kpi-container {
    display: flex;
    justify-content: center;
    gap: 50px;
    margin: 20px;
  }
  .kpi {
    background: #fff;
    padding: 20px 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    min-width: 120px;
  }
  .kpi h2 {
    margin: 0;
    font-size: 28px;
    color: #e74c3c;
  }
  .kpi p {
    margin: 5px 0 0 0;
    font-size: 14px;
    color: #555;
  }
  .chart-container {
    width: 90%;
    max-width: 600px;
    margin: 30px auto;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .buttons {
    display: flex;
    justify-content: space-between;
    margin: 20px 50px;
  }
  button {
    padding: 10px 20px;
    font-size: 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background-color: #3498db;
    color: #fff;
  }
  button:hover {
    background-color: #2980b9;
  }
  footer {
    text-align: center;
    padding: 15px;
    font-size: 12px;
    color: #777;
  }
  footer a {
    color: #3498db;
    text-decoration: none;
  }

  /* Responsive */
  @media(max-width:768px){
    .filters {
      flex-direction: column;
      align-items: center;
    }
    .buttons {
      flex-direction: column;
      gap: 10px;
      margin: 20px;
    }
  }

  /* Print A4 */
  @media print {
    body {
      background: #fff;
    }
    .buttons, header img {
      display: none;
    }
    .chart-container {
      box-shadow: none;
      border-radius: 0;
    }
  }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- PapaParse for CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<header>
  <img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU" alt="Sadiq Abbasi Hospital Logo">
  <h1>SADIQ ABBASI HOSPITAL, BAHAWALPUR – Mortality Dashboard</h1>
</header>

<div class="filters">
  <div class="filter-group">
    <label>From Date</label>
    <input type="date" id="fromDate">
  </div>
  <div class="filter-group">
    <label>To Date</label>
    <input type="date" id="toDate">
  </div>
  <div class="filter-group">
    <label>Department</label>
    <select id="department"><option value="">All</option></select>
  </div>
  <div class="filter-group">
    <label>District</label>
    <select id="district"><option value="">All</option></select>
  </div>
  <div class="filter-group">
    <label>Diagnosis</label>
    <select id="diagnosis"><option value="">All</option></select>
  </div>
  <div class="filter-group">
    <label>Gender</label>
    <select id="gender"><option value="">All</option></select>
  </div>
  <div class="filter-group">
    <label>Age Group</label>
    <select id="ageGroup">
      <option value="">All</option>
      <option value="0-30d">Below 30 Days</option>
      <option value="1m-1y">1 Month to 1 Year</option>
      <option value="1y-15y">1 Year to 15 Years</option>
      <option value="15y-30y">15 to 30 Years</option>
      <option value="30y-45y">30 to 45 Years</option>
      <option value="45y-60y">45 to 60 Years</option>
      <option value="65+">65 Years & above</option>
    </select>
  </div>
</div>

<div class="kpi-container">
  <div class="kpi">
    <h2 id="totalDeaths">0</h2>
    <p>Total Deaths</p>
  </div>
  <div class="kpi">
    <h2 id="maleDeaths">0</h2>
    <p>Total Male Deaths</p>
  </div>
  <div class="kpi">
    <h2 id="femaleDeaths">0</h2>
    <p>Total Female Deaths</p>
  </div>
</div>

<div class="chart-container">
  <canvas id="departmentChart"></canvas>
</div>

<div class="buttons">
  <button id="exportPdf">Export to PDF</button>
  <button onclick="location.reload()">Refresh</button>
</div>

<footer>
  Developed By: <a href="https://www.linkedin.com/in/smus79" target="_blank">Software Engineer MUHAMMAD UMAIR SYED (IT Officer, Sadiq Abbasi Hospital, Bahawalpur)</a>
</footer>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData = [];
let chart;

function fetchData() {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: function(results) {
      rawData = results.data;
      populateFilters();
      updateDashboard();
    }
  });
}

// Populate filter dropdowns
function populateFilters() {
  const deptSet = new Set(), distSet = new Set(), diagSet = new Set(), genderSet = new Set();

  rawData.forEach(row => {
    if(row['I']) deptSet.add(row['I']);
    if(row['V']) distSet.add(row['V']);
    if(row['U']) diagSet.add(row['U']);
    if(row['G']) genderSet.add(row['G']);
  });

  fillDropdown('department', Array.from(deptSet).sort());
  fillDropdown('district', Array.from(distSet).sort());
  fillDropdown('diagnosis', Array.from(diagSet).sort());
  fillDropdown('gender', Array.from(genderSet).sort());
}

function fillDropdown(id, items){
  const select = document.getElementById(id);
  select.innerHTML = '<option value="">All</option>';
  items.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    select.appendChild(opt);
  });
}

// Filter data based on selections
function filterData() {
  const fromDate = document.getElementById('fromDate').value;
  const toDate = document.getElementById('toDate').value;
  const department = document.getElementById('department').value;
  const district = document.getElementById('district').value;
  const diagnosis = document.getElementById('diagnosis').value;
  const gender = document.getElementById('gender').value;
  const ageGroup = document.getElementById('ageGroup').value;

  return rawData.filter(row => {
    const rowDate = row['D'] ? new Date(row['D']) : null;
    if(fromDate && rowDate < new Date(fromDate)) return false;
    if(toDate && rowDate > new Date(toDate)) return false;
    if(department && row['I'] !== department) return false;
    if(district && row['V'] !== district) return false;
    if(diagnosis && row['U'] !== diagnosis) return false;
    if(gender && row['G'] !== gender) return false;

    if(ageGroup){
      const age = parseInt(row['F']); // Assuming column F = Age in days or years
      switch(ageGroup){
        case '0-30d': if(age > 30/365) return false; break;
        case '1m-1y': if(age < 30/365 || age > 1) return false; break;
        case '1y-15y': if(age < 1 || age > 15) return false; break;
        case '15y-30y': if(age < 15 || age > 30) return false; break;
        case '30y-45y': if(age < 30 || age > 45) return false; break;
        case '45y-60y': if(age < 45 || age > 60) return false; break;
        case '65+': if(age < 65) return false; break;
      }
    }

    return true;
  });
}

function updateDashboard(){
  const data = filterData();

  // KPIs
  document.getElementById('totalDeaths').textContent = data.length;
  document.getElementById('maleDeaths').textContent = data.filter(r=>r['G']==='Male').length;
  document.getElementById('femaleDeaths').textContent = data.filter(r=>r['G']==='Female').length;

  // Pie chart for Department
  const deptCounts = {};
  data.forEach(r => { if(r['I']) deptCounts[r['I']] = (deptCounts[r['I']]||0)+1; });
  const labels = Object.keys(deptCounts);
  const values = Object.values(deptCounts);

  if(chart) chart.destroy();
  const ctx = document.getElementById('departmentChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map(()=>randomColor())
      }]
    },
    options: {
      responsive:true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

// Random pastel color
function randomColor(){
  const r = Math.floor(Math.random()*200)+50;
  const g = Math.floor(Math.random()*200)+50;
  const b = Math.floor(Math.random()*200)+50;
  return `rgb(${r},${g},${b})`;
}

// Event listeners
document.querySelectorAll('.filters select, .filters input').forEach(el=>{
  el.addEventListener('change', updateDashboard);
});

// Export to PDF
document.getElementById('exportPdf').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  doc.html(document.body, {
    callback: function (doc) { doc.save('Mortality_Dashboard.pdf'); },
    x: 10,
    y: 10,
    width: 190
  });
});

fetchData();
</script>

</body>
</html>
