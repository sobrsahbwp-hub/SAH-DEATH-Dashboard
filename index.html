<!FINAL MORTALITY DASHBOARD>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sadiq Abbasi Hospital - Mortality Dashboard</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--bg:#f4f8fc;
--card:#ffffff;
--text:#111;
--primary:#007BFF;
}
body.dark{
--bg:#1e1e1e;
--card:#2c2c2c;
--text:#f5f5f5;
--primary:#4da3ff;
}

body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:var(--bg);
color:var(--text);
transition:0.3s;
}

.top-bar{
display:flex;
justify-content:flex-end;
padding:10px 20px;
background:var(--card);
box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.clock{
font-weight:bold;
color:var(--primary);
}

header{
text-align:center;
padding:15px;
background:var(--card);
}

.logo{height:80px;}

.filters{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
gap:15px;
padding:20px;
}

select,input{
padding:6px;
border-radius:6px;
border:1px solid #ccc;
width:100%;
}

.kpis{
display:flex;
justify-content:center;
flex-wrap:wrap;
gap:20px;
padding:10px;
}

.kpi{
background:var(--card);
padding:20px;
border-radius:10px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
text-align:center;
width:220px;
}

.chart-wrapper{
display:flex;
flex-wrap:wrap;
justify-content:center;
gap:30px;
padding:20px;
}

.chart-box{
background:var(--card);
padding:20px;
border-radius:10px;
width:480px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

footer{
text-align:center;
padding:15px;
background:var(--card);
}

footer a{
color:var(--primary);
text-decoration:none;
font-weight:bold;
}

.floating-btn{
position:fixed;
bottom:20px;
padding:10px 15px;
border:none;
border-radius:6px;
cursor:pointer;
color:white;
font-weight:bold;
}

#exportBtn{
left:20px;
background:#28a745;
}

#themeBtn{
right:20px;
background:#333;
}
</style>
</head>

<body>

<div class="top-bar">
<div class="clock" id="clock"></div>
</div>

<header>
<img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU" class="logo">
<h2>SADIQ ABBASI HOSPITAL, BAHAWALPUR</h2>
<h3>Hospital Mortality Dashboard</h3>
</header>

<div class="filters">
<div><label>From Date</label><input type="date" id="fromDate"></div>
<div><label>To Date</label><input type="date" id="toDate"></div>
<div><label>Department</label><select id="department"><option value="">All</option></select></div>
<div><label>District</label><select id="district"><option value="">All</option></select></div>
<div><label>Gender</label><select id="gender"><option value="">All</option></select></div>
</div>

<div class="kpis">
<div class="kpi"><h4>Total Deaths</h4><h2 id="totalDeaths">0</h2></div>
<div class="kpi"><h4>Total Male Deaths</h4><h2 id="maleDeaths">0</h2></div>
<div class="kpi"><h4>Total Female Deaths</h4><h2 id="femaleDeaths">0</h2></div>
</div>

<div class="chart-wrapper">
<div class="chart-box">
<h4>Department Wise Deaths</h4>
<canvas id="deptChart"></canvas>
</div>

<div class="chart-box">
<h4>District Wise Distribution</h4>
<canvas id="districtChart"></canvas>
</div>
</div>

<footer>
Developed By:
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED
(IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</a>
</footer>

<button id="exportBtn" class="floating-btn">Export Executive Summary</button>
<button id="themeBtn" class="floating-btn">Toggle Theme</button>

<script>

const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[], deptChart, districtChart;

/* CLOCK */
function updateClock(){
const now=new Date();
clock.innerHTML=now.toLocaleDateString()+" | "+now.toLocaleTimeString();
}
setInterval(updateClock,1000);
updateClock();

/* LOAD DATA */
Papa.parse(sheetURL,{
download:true,
header:true,
skipEmptyLines:true,
complete:function(results){

rawData=results.data.map(r=>({
DATE:new Date(r["DATE"]),
GENDER:(r["GENDER"]||"").toLowerCase().trim(),
DEPARTMENT:(r["DEPARTMENT"]||"").trim(),
DISTRICT:(r["DISTRICT"]||"").trim()
}));

populateFilters();
applyFilters();
}
});

function populateSelect(key,id){
const select=document.getElementById(id);
const values=[...new Set(rawData.map(d=>d[key]).filter(v=>v))].sort();
values.forEach(v=>{
select.innerHTML+=`<option value="${v}">${v}</option>`;
});
}

function populateFilters(){
populateSelect("DEPARTMENT","department");
populateSelect("DISTRICT","district");
populateSelect("GENDER","gender");
}

document.querySelectorAll("select,input").forEach(el=>{
el.addEventListener("change",applyFilters);
});

function applyFilters(){

const fromDate=fromDateInput.value?new Date(fromDateInput.value):null;
const toDate=toDateInput.value?new Date(toDateInput.value):null;

let filtered=rawData.filter(d=>{

return (!fromDate || d.DATE>=fromDate) &&
(!toDate || d.DATE<=toDate) &&
(!department.value || d.DEPARTMENT===department.value) &&
(!district.value || d.DISTRICT===district.value) &&
(!gender.value || d.GENDER===gender.value);
});

totalDeaths.innerText=filtered.length;
maleDeaths.innerText=filtered.filter(d=>d.GENDER==="male").length;
femaleDeaths.innerText=filtered.filter(d=>d.GENDER==="female").length;

createCharts(filtered);
}

function createCharts(data){

let deptGroup={}, districtGroup={};

data.forEach(d=>{
if(d.DEPARTMENT)
deptGroup[d.DEPARTMENT]=(deptGroup[d.DEPARTMENT]||0)+1;

if(d.DISTRICT)
districtGroup[d.DISTRICT]=(districtGroup[d.DISTRICT]||0)+1;
});

if(deptChart) deptChart.destroy();
if(districtChart) districtChart.destroy();

deptChart=new Chart(document.getElementById("deptChart"),{
type:"bar",
data:{
labels:Object.keys(deptGroup),
datasets:[{
data:Object.values(deptGroup),
backgroundColor:Object.keys(deptGroup).map((_,i)=>`hsl(${i*60},70%,55%)`)
}]
},
options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
});

districtChart=new Chart(document.getElementById("districtChart"),{
type:"pie",
data:{
labels:Object.keys(districtGroup),
datasets:[{
data:Object.values(districtGroup),
backgroundColor:Object.keys(districtGroup).map((_,i)=>`hsl(${i*50},70%,55%)`)
}]
}
});
}

/* EXPORT PDF */
document.getElementById("exportBtn").addEventListener("click",()=>{
html2canvas(document.body).then(canvas=>{
const img=canvas.toDataURL("image/png");
const pdf=new jspdf.jsPDF("p","mm","a4");
pdf.addImage(img,"PNG",5,5,200,0);
pdf.save("Executive_Summary.pdf");
});
});

/* THEME TOGGLE */
document.getElementById("themeBtn").addEventListener("click",()=>{
document.body.classList.toggle("dark");
});

const fromDateInput=document.getElementById("fromDate");
const toDateInput=document.getElementById("toDate");

</script>
</body>
</html>
