<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hospital Mortality Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
    font-family: 'Segoe UI', sans-serif;
    margin:0;
    background:#f4f7fb;
    color:#222;
}
.header{
    text-align:center;
    padding:20px;
    background:#ffffff;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
}
.header img{
    height:80px;
}
.header h2{
    margin:10px 0 0 0;
    color:#0a3d62;
}
.container{
    padding:20px;
}
.filters{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
    gap:15px;
    margin-bottom:20px;
}
.filter-box{
    display:flex;
    flex-direction:column;
}
.filter-box label{
    font-weight:600;
    margin-bottom:5px;
}
select,input{
    padding:8px;
    border:1px solid #ccc;
    border-radius:6px;
}
.kpis{
    display:flex;
    flex-wrap:wrap;
    gap:15px;
    margin-bottom:20px;
}
.kpi{
    flex:1;
    min-width:200px;
    background:white;
    padding:20px;
    border-radius:10px;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
.kpi h3{
    margin:0;
    font-size:16px;
}
.kpi p{
    font-size:28px;
    margin:10px 0 0 0;
    font-weight:bold;
    color:#0a3d62;
}
.chart-container{
    text-align:center;
    background:white;
    padding:20px;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
.footer{
    text-align:center;
    padding:15px;
    margin-top:20px;
    font-size:14px;
}
.buttons{
    display:flex;
    justify-content:space-between;
    margin-top:20px;
}
button{
    padding:10px 20px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
}
.pdf-btn{ background:#0a3d62; color:white; }
.refresh-btn{ background:#16a085; color:white; }

@media print{
    body{ background:white; }
    .buttons{ display:none; }
}

@page{
    size:A4;
    margin:10mm;
}
</style>
</head>

<body>

<div id="dashboard">

<div class="header">
    <img src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU" alt="Hospital Logo">
    <h2>SADIQ ABBASI HOSPITAL, BAHAWALPUR</h2>
    <h3>Mortality Dashboard</h3>
</div>

<div class="container">

<div class="filters">

<div class="filter-box">
<label>From Date</label>
<input type="date" id="fromDate">
</div>

<div class="filter-box">
<label>To Date</label>
<input type="date" id="toDate">
</div>

<div class="filter-box">
<label>DEPARTMENT</label>
<select id="department"></select>
</div>

<div class="filter-box">
<label>DISTRICT</label>
<select id="district"></select>
</div>

<div class="filter-box">
<label>DIAGNOSIS</label>
<select id="diagnosis"></select>
</div>

<div class="filter-box">
<label>GENDER</label>
<select id="gender"></select>
</div>

<div class="filter-box">
<label>AGE GROUP</label>
<select id="ageGroup">
<option value="">All</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 Years to 45 Years</option>
<option>45 Years to 60 Years</option>
<option>65 Years & above</option>
</select>
</div>

</div>

<div class="kpis">
<div class="kpi">
<h3>Total Deaths</h3>
<p id="totalDeaths">0</p>
</div>
<div class="kpi">
<h3>Total Male Deaths</h3>
<p id="maleDeaths">0</p>
</div>
<div class="kpi">
<h3>Total Female Deaths</h3>
<p id="femaleDeaths">0</p>
</div>
</div>

<div class="chart-container">
<canvas id="deptChart" height="120"></canvas>
</div>

<div class="buttons">
<button class="pdf-btn" onclick="exportPDF()">Export to PDF</button>
<button class="refresh-btn" onclick="location.reload()">Refresh</button>
</div>

</div>

<div class="footer">
Developed By: 
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED
</a> 
(IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</div>

</div>

<script>

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData = [];
let chart;

fetch(csvUrl)
.then(res => res.text())
.then(data => {
    const rows = data.split("\n").map(r => r.split(","));
    const headers = rows[0];
    rawData = rows.slice(1);
    populateDropdown(8, "department");  // Column I
    populateDropdown(21, "diagnosis");  // Column U
    populateDropdown(6, "gender");      // Column G
    populateDropdown(21+1, "district"); // Column V (22 index)
    applyFilters();
});

function populateDropdown(colIndex, id){
    const dropdown = document.getElementById(id);
    dropdown.innerHTML = "<option value=''>All</option>";
    const values = [...new Set(rawData.map(r => r[colIndex]))].filter(v => v);
    values.sort().forEach(val=>{
        dropdown.innerHTML += `<option>${val}</option>`;
    });
}

document.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change", applyFilters);
});

function ageMatch(age, group){
    age = parseInt(age);
    if(!group) return true;
    if(group==="Below 30 Days") return age < 1/12;
    if(group==="1 Month to 1 Year") return age>=1/12 && age<1;
    if(group==="1 Year to 15 Years") return age>=1 && age<=15;
    if(group==="15 to 30 Years") return age>15 && age<=30;
    if(group==="30 Years to 45 Years") return age>30 && age<=45;
    if(group==="45 Years to 60 Years") return age>45 && age<=60;
    if(group==="65 Years & above") return age>=65;
    return true;
}

function applyFilters(){
    const fromDate = new Date(document.getElementById("fromDate").value);
    const toDate = new Date(document.getElementById("toDate").value);
    const dept = department.value;
    const dist = district.value;
    const diag = diagnosis.value;
    const gender = document.getElementById("gender").value;
    const ageGroup = document.getElementById("ageGroup").value;

    let filtered = rawData.filter(r=>{
        const rowDate = new Date(r[0]);
        return (!fromDate || rowDate>=fromDate) &&
               (!toDate || rowDate<=toDate) &&
               (!dept || r[8]===dept) &&
               (!dist || r[22]===dist) &&
               (!diag || r[21]===diag) &&
               (!gender || r[6]===gender) &&
               ageMatch(r[3], ageGroup);
    });

    document.getElementById("totalDeaths").innerText = filtered.length;
    document.getElementById("maleDeaths").innerText = filtered.filter(r=>r[6]==="Male").length;
    document.getElementById("femaleDeaths").innerText = filtered.filter(r=>r[6]==="Female").length;

    const deptCounts = {};
    filtered.forEach(r=>{
        deptCounts[r[8]] = (deptCounts[r[8]]||0)+1;
    });

    const labels = Object.keys(deptCounts);
    const data = Object.values(deptCounts);

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("deptChart"),{
        type:'bar',
        data:{
            labels:labels,
            datasets:[{
                label:'Deaths by Department',
                data:data,
                backgroundColor:[
                    '#3498db','#e74c3c','#2ecc71','#9b59b6',
                    '#f39c12','#1abc9c','#34495e','#e67e22'
                ]
            }]
        },
        options:{
            responsive:true,
            plugins:{
                legend:{ display:false }
            }
        }
    });
}

function exportPDF(){
    const element = document.getElementById("dashboard");
    html2pdf().from(element).set({
        margin:10,
        filename:'Mortality_Dashboard.pdf',
        html2canvas:{ scale:2 },
        jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
    }).save();
}

</script>

</body>
</html>
