<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hospital Mortality Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
    margin:0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background:#f2f6fa;
}

header{
    background:#ffffff;
    padding:15px;
    text-align:center;
    font-size:22px;
    font-weight:600;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
    position:relative;
}

#clock{
    position:absolute;
    right:20px;
    top:18px;
    font-size:14px;
    color:#555;
}

.container{padding:20px;}

.filters{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:15px;
    margin-bottom:25px;
}

.filter-box{
    display:flex;
    flex-direction:column;
    min-width:160px;
}

label{
    font-size:12px;
    font-weight:600;
    margin-bottom:4px;
}

select,input{
    padding:6px;
    border-radius:6px;
    border:1px solid #ccd6dd;
}

.kpis{
    display:flex;
    justify-content:center;
    gap:20px;
    flex-wrap:wrap;
    margin-bottom:30px;
}

.kpi{
    background:#ffffff;
    padding:18px;
    width:200px;
    text-align:center;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
}

.kpi h2{
    margin:0;
    font-size:26px;
    color:#0077b6;
}

.kpi p{
    margin-top:6px;
    font-size:13px;
    color:#555;
}

.charts{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:40px;
}

canvas{
    background:#ffffff;
    padding:15px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    max-width:500px;
}

.bottom-buttons{
    position:fixed;
    bottom:15px;
    width:100%;
    display:flex;
    justify-content:space-between;
    padding:0 20px;
}

button{
    padding:8px 16px;
    border:none;
    border-radius:6px;
    background:#0077b6;
    color:white;
    cursor:pointer;
    font-size:13px;
}

button:hover{background:#023e8a;}

.footer{
    margin-top:60px;
    text-align:center;
    padding:15px;
    font-size:12px;
    background:#ffffff;
}

.footer a{
    color:#0077b6;
    font-weight:600;
    text-decoration:none;
}

@media(max-width:768px){
    .charts{flex-direction:column;align-items:center;}
}
</style>
</head>

<body>

<header>
Hospital Mortality Dashboard
<div id="clock"></div>
</header>

<div class="container" id="dashboard">

<div class="filters">

<div class="filter-box">
<label>From Date</label>
<input type="date" id="fromDate">
</div>

<div class="filter-box">
<label>To Date</label>
<input type="date" id="toDate">
</div>

<div class="filter-box">
<label>Department</label>
<select id="department"></select>
</div>

<div class="filter-box">
<label>District</label>
<select id="district"></select>
</div>

<div class="filter-box">
<label>Diagnosis</label>
<select id="diagnosis"></select>
</div>

<div class="filter-box">
<label>Gender</label>
<select id="gender"></select>
</div>

<div class="filter-box">
<label>Age Group</label>
<select id="ageGroup">
<option value="">All</option>
<option value="neonate">Below 30 Days</option>
<option value="infant">1 Month to 1 Year</option>
<option value="child">1 Year to 15 Years</option>
<option value="young">15 to 30 Years</option>
<option value="adult">30 to 45 Years</option>
<option value="middle">45 to 60 Years</option>
<option value="elder">65 Years & above</option>
</select>
</div>

</div>

<div class="kpis">
<div class="kpi"><h2 id="totalDeaths">0</h2><p>Total Deaths</p></div>
<div class="kpi"><h2 id="maleDeaths">0</h2><p>Total Male Deaths</p></div>
<div class="kpi"><h2 id="femaleDeaths">0</h2><p>Total Female Deaths</p></div>
</div>

<div class="charts">
<canvas id="deptChart"></canvas>
<canvas id="districtChart"></canvas>
</div>

</div>

<div class="bottom-buttons">
<button onclick="generatePDF()">Executive PDF Summary</button>
<button onclick="location.reload()">Refresh</button>
</div>

<div class="footer">
Developed By:
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED (IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</a>
</div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";
let rawData=[];
let deptChart,districtChart;

/* Clock */
function updateClock(){
    document.getElementById("clock").innerText=new Date().toLocaleString();
}
setInterval(updateClock,1000);
updateClock();

/* Fetch CSV */
Papa.parse(csvUrl,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:function(results){
        rawData=results.data;
        populateFilters();
        applyFilters();
    }
});

/* Robust Age Parser */
function parseAgeToYears(ageValue){

    if(!ageValue) return null;

    let val=ageValue.toString().trim().toLowerCase();

    let num=parseFloat(val.replace(/[^\d.]/g,''));
    if(isNaN(num)) return null;

    if(val.includes("day") || val.includes("d")){
        return num/365;
    }

    if(val.includes("month") || val.includes("m")){
        return num/12;
    }

    if(val.includes("year") || val.includes("y")){
        return num;
    }

    return num; 
}

/* Age Group Logic */
function ageGroupMatch(row){
    let group=document.getElementById("ageGroup").value;
    if(!group) return true;

    let age=parseAgeToYears(row["AGE"]);
    if(age===null) return true;

    switch(group){
        case "neonate": return age < (30/365);
        case "infant": return age >= (30/365) && age < 1;
        case "child": return age >=1 && age <=15;
        case "young": return age >15 && age <=30;
        case "adult": return age >30 && age <=45;
        case "middle": return age >45 && age <=60;
        case "elder": return age >=65;
        default: return true;
    }
}

/* Filter Utilities */
function uniqueValues(col){
    return [...new Set(rawData.map(r=>r[col]).filter(v=>v))].sort();
}

function fillDropdown(id,col){
    let select=document.getElementById(id);
    select.innerHTML="<option value=''>All</option>";
    uniqueValues(col).forEach(v=>{
        let opt=document.createElement("option");
        opt.text=v;
        select.add(opt);
    });
}

function populateFilters(){
    fillDropdown("department","DEPARTMENT");
    fillDropdown("district","DISTRICT");
    fillDropdown("diagnosis","DIAGNOSIS");
    fillDropdown("gender","GENDER");
}

document.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change",applyFilters);
});

/* Apply Filters */
function applyFilters(){

    let from=document.getElementById("fromDate").value;
    let to=document.getElementById("toDate").value;

    let filtered=rawData.filter(row=>{

        let date=new Date(row["DATE"]);
        if(from && date < new Date(from)) return false;
        if(to && date > new Date(to)) return false;

        if(document.getElementById("department").value && row["DEPARTMENT"]!==document.getElementById("department").value) return false;
        if(document.getElementById("district").value && row["DISTRICT"]!==document.getElementById("district").value) return false;
        if(document.getElementById("diagnosis").value && row["DIAGNOSIS"]!==document.getElementById("diagnosis").value) return false;
        if(document.getElementById("gender").value && row["GENDER"]!==document.getElementById("gender").value) return false;

        if(!ageGroupMatch(row)) return false;

        return true;
    });

    updateKPIs(filtered);
    drawCharts(filtered);
}

/* KPI Update */
function updateKPIs(data){
    document.getElementById("totalDeaths").innerText=data.length;
    document.getElementById("maleDeaths").innerText=data.filter(r=>r["GENDER"]==="Male").length;
    document.getElementById("femaleDeaths").innerText=data.filter(r=>r["GENDER"]==="Female").length;
}

/* Grouping */
function groupBy(data,key){
    return data.reduce((acc,row)=>{
        acc[row[key]]=(acc[row[key]]||0)+1;
        return acc;
    },{});
}

/* Charts */
function drawCharts(data){

    let deptData=groupBy(data,"DEPARTMENT");
    let distData=groupBy(data,"DISTRICT");

    if(deptChart) deptChart.destroy();
    if(districtChart) districtChart.destroy();

    deptChart=new Chart(document.getElementById("deptChart"),{
        type:"bar",
        data:{
            labels:Object.keys(deptData),
            datasets:[{
                data:Object.values(deptData),
                backgroundColor:["#0077b6","#0096c7","#00b4d8","#48cae4","#90e0ef","#ade8f4","#caf0f8"]
            }]
        },
        options:{
            plugins:{legend:{display:false}},
            responsive:true
        }
    });

    districtChart=new Chart(document.getElementById("districtChart"),{
        type:"pie",
        data:{
            labels:Object.keys(distData),
            datasets:[{
                data:Object.values(distData),
                backgroundColor:["#ff6b6b","#feca57","#48dbfb","#1dd1a1","#5f27cd","#ee5253","#ff9f43"]
            }]
        },
        options:{responsive:true}
    });
}

/* PDF */
function generatePDF(){
    html2pdf().from(document.getElementById("dashboard"))
    .set({margin:0.5, filename:"Executive_Mortality_Summary.pdf"})
    .save();
}

</script>
</body>
</html>
