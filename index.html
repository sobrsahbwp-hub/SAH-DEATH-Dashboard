<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hospital Mortality Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:Segoe UI, sans-serif;
background:#f4f8fc;
margin:0;
padding:20px;
}

.header{text-align:center;margin-bottom:20px;}
.logo{height:90px;}

h1{color:#003366;margin:10px 0 5px;}
h3{margin-top:0;color:#555;}

.filters{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:15px;
margin-bottom:25px;
}

.filter-box{display:flex;flex-direction:column;}

label{font-weight:600;margin-bottom:5px;}

select,input{
padding:8px;
border-radius:6px;
border:1px solid #ccc;
}

.kpis{
display:flex;
flex-wrap:wrap;
justify-content:center;
gap:20px;
margin-bottom:25px;
}

.kpi{
background:white;
padding:20px;
border-radius:12px;
box-shadow:0 4px 10px rgba(0,0,0,0.08);
min-width:200px;
text-align:center;
}

.kpi h2{margin:0;color:#003366;font-size:28px;}

.chart-container{
max-width:800px;
margin:auto;
background:white;
padding:20px;
border-radius:12px;
box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

.buttons{
display:flex;
justify-content:space-between;
margin-top:25px;
}

button{
padding:10px 20px;
border:none;
border-radius:8px;
background:#003366;
color:white;
cursor:pointer;
}

.footer{
margin-top:40px;
text-align:center;
font-size:14px;
color:#444;
}

@media print{
button{display:none;}
body{background:white;}
}
</style>
</head>

<body>

<div id="dashboard">

<div class="header">
<img class="logo"
src="https://drive.google.com/uc?export=view&id=1Y5PbMKEFDgSk9CiSZOAdVyxRyAse6hXU">
<h1>SADIQ ABBASI HOSPITAL, BAHAWALPUR</h1>
<h3>Hospital Mortality Dashboard</h3>
</div>

<div class="filters">

<div class="filter-box">
<label>From Date</label>
<input type="date" id="fromDate">
</div>

<div class="filter-box">
<label>To Date</label>
<input type="date" id="toDate">
</div>

<div class="filter-box">
<label>Department</label>
<select id="department"></select>
</div>

<div class="filter-box">
<label>District</label>
<select id="district"></select>
</div>

<div class="filter-box">
<label>Diagnosis</label>
<select id="diagnosis"></select>
</div>

<div class="filter-box">
<label>Gender</label>
<select id="gender"></select>
</div>

<div class="filter-box">
<label>Age Group</label>
<select id="ageGroup">
<option>ALL</option>
<option>Below 30 Days</option>
<option>1 Month to 1 Year</option>
<option>1 Year to 15 Years</option>
<option>15 to 30 Years</option>
<option>30 Years to 45 Years</option>
<option>45 Years to 60 Years</option>
<option>65 Years & above</option>
</select>
</div>

</div>

<div class="kpis">
<div class="kpi"><h2 id="total">0</h2>Total Deaths</div>
<div class="kpi"><h2 id="male">0</h2>Male Deaths</div>
<div class="kpi"><h2 id="female">0</h2>Female Deaths</div>
</div>

<div class="chart-container">
<canvas id="deptChart"></canvas>
</div>

<div class="buttons">
<button onclick="exportPDF()">Export to PDF</button>
<button onclick="location.reload()">Refresh</button>
</div>

<div class="footer">
Developed By:
<a href="https://www.linkedin.com/in/smus79" target="_blank">
Software Engineer MUHAMMAD UMAIR SYED
</a>
(IT Officer, Sadiq Abbasi Hospital, Bahawalpur)
</div>

</div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz914IFr1jBOBuiujol-M_LYK9qLBtaHeAsQtqW8xvJqyZxwRee5yRIK6wHj4HrISYzCE5LxucL59C/pub?gid=801410960&single=true&output=csv";

let rawData=[];
let chart;

fetch(csvUrl)
.then(res=>res.text())
.then(text=>{
const rows=text.trim().split("\n")
.map(r=>r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));

rawData=rows.slice(1);

populateDropdown(8,"department"); // Column I
populateDropdown(21,"district"); // Column V
populateDropdown(20,"diagnosis"); // Column U
populateDropdown(6,"gender"); // Column G

applyFilters();
});

function populateDropdown(colIndex,id){
let values=[...new Set(rawData.map(r=>r[colIndex]?.replace(/"/g,"").trim()).filter(Boolean))].sort();
let select=document.getElementById(id);
select.innerHTML="<option>ALL</option>";
values.forEach(v=>{
let opt=document.createElement("option");
opt.text=v;
select.add(opt);
});
}

document.querySelectorAll("select,input")
.forEach(el=>el.addEventListener("change",applyFilters));

function ageCheck(age,group){
age=parseFloat(age);
if(!age) return false;

switch(group){
case "Below 30 Days": return age<0.1;
case "1 Month to 1 Year": return age>=0.1 && age<1;
case "1 Year to 15 Years": return age>=1 && age<=15;
case "15 to 30 Years": return age>15 && age<=30;
case "30 Years to 45 Years": return age>30 && age<=45;
case "45 Years to 60 Years": return age>45 && age<=60;
case "65 Years & above": return age>=65;
default:return true;
}
}

function applyFilters(){

let from=document.getElementById("fromDate").value;
let to=document.getElementById("toDate").value;
let dept=document.getElementById("department").value;
let district=document.getElementById("district").value;
let diagnosis=document.getElementById("diagnosis").value;
let gender=document.getElementById("gender").value;
let ageGroup=document.getElementById("ageGroup").value;

let filtered=rawData.filter(r=>{

let date=r[1];
if(from && date<from) return false;
if(to && date>to) return false;
if(dept!="ALL" && r[8]!=dept) return false;
if(district!="ALL" && r[21]!=district) return false;
if(diagnosis!="ALL" && r[20]!=diagnosis) return false;
if(gender!="ALL" && r[6]!=gender) return false;
if(ageGroup!="ALL" && !ageCheck(r[7],ageGroup)) return false;

return true;
});

document.getElementById("total").innerText=filtered.length;
document.getElementById("male").innerText=
filtered.filter(r=>r[6]=="MALE").length;
document.getElementById("female").innerText=
filtered.filter(r=>r[6]=="FEMALE").length;

let deptCounts={};
filtered.forEach(r=>{
let d=r[8];
deptCounts[d]=(deptCounts[d]||0)+1;
});

drawChart(deptCounts);
}

function drawChart(dataObj){
if(chart) chart.destroy();

chart=new Chart(document.getElementById("deptChart"),{
type:"bar",
data:{
labels:Object.keys(dataObj),
datasets:[{
data:Object.values(dataObj),
backgroundColor:[
"#003366","#006699","#0099cc","#00cccc",
"#33cccc","#66cccc","#ff6666","#ff9966",
"#ffcc66","#cc6699","#6699ff"
]
}]
},
options:{
plugins:{legend:{display:false}},
responsive:true,
scales:{y:{beginAtZero:true}}
}
});
}

function exportPDF(){
html2canvas(document.querySelector("#dashboard")).then(canvas=>{
const img=canvas.toDataURL("image/png");
const {jsPDF}=window.jspdf;
let pdf=new jsPDF("p","mm","a4");
let width=210;
let height=canvas.height*width/canvas.width;
pdf.addImage(img,"PNG",0,0,width,height);
pdf.save("Mortality-Dashboard.pdf");
});
}

</script>

</body>
</html>
